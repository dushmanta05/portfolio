---
import type { iconPaths } from '@components/IconPaths';
import Icon from '@components/Icon.astro';
import ThemeToggle from '@components/ThemeToggle.astro';
import SectionDivider from '@components/common/SectionDivider.astro';

const textLinks: { label: string; href: string }[] = [
  { label: 'Home', href: '/' },
  { label: 'Work', href: '/work/' },
  { label: 'About', href: '/about/' },
  { label: 'Blog', href: '/blog' },
];

const iconLinks: {
  label: string;
  href: string;
  icon: keyof typeof iconPaths;
}[] = [
  {
    label: 'GitHub',
    href: 'https://github.com/dushmanta05',
    icon: 'github',
  },
  {
    label: 'LinkedIn',
    href: 'https://www.linkedin.com/in/dushmanta05/',
    icon: 'linkedin',
  },
  {
    label: 'X',
    href: 'https://x.com/dushmanta05',
    icon: 'xLogo',
  },
];
---

<nav class='w-full mx-auto px-6 navbar'>
  <div class='max-w-7xl flex items-center justify-between h-16 mx-auto md:px-4 sm:px-6 lg:px-8'>
    <!-- Brand/Logo -->
    <div class='flex-shrink-0'>
      <a href='/' class='brand-title'>
        <Icon icon='terminal' color='var(--accent-regular)' size='1.6em' gradient />
        Dushmanta
      </a>
    </div>

    <div class='hidden md:flex flex-1 justify-center'>
      <ul class='flex items-center gap-1 list-none m-0 p-0'>
        {
          textLinks.map(({ label, href }) => (
            <li>
              <a
                aria-current={Astro.url.pathname === href}
                class:list={[
                  'nav-link',
                  {
                    active:
                      Astro.url.pathname === href ||
                      (href !== '/' && Astro.url.pathname.startsWith(href)),
                  },
                ]}
                href={href}
              >
                {label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>

    <div class='hidden md:flex items-center gap-4'>
      <div class='flex items-center gap-2'>
        {
          iconLinks.map(({ href, icon, label }) => (
            <a href={href} class='social-link' target='_blank' rel='noopener noreferrer'>
              <span class='sr-only'>{label}</span>
              <Icon icon={icon} size='1em' />
            </a>
          ))
        }
      </div>
      <ThemeToggle />
    </div>

    <!-- Mobile Menu Button -->
    <menu-button class='md:hidden'>
      <template>
        <button class='menu-toggle' aria-expanded='false' type='button'>
          <span class='sr-only'>Menu</span>
          <div class='hamburger w-6 h-5 relative'>
            <span class='top-0'></span>
            <span class='top-1/2 transform -translate-y-1/2'></span>
            <span class='bottom-0'></span>
          </div>
        </button>
      </template>
    </menu-button>
  </div>

  <!-- Mobile Menu Overlay -->
  <div id='mobile-menu' class='mobile-menu' hidden>
    <div class='mobile-menu-header'>
      <a href='/' class='brand-title'>
        <Icon icon='terminal' color='var(--accent-regular)' size='1.6em' gradient />
        Dushmanta
      </a>
      <button class='close-menu' aria-label='Close menu' type='button'>
        <Icon icon='close' size='1.5em' />
      </button>
    </div>

    <div class='mobile-menu-content'>
      <ul class='mobile-nav-items'>
        {
          textLinks.map(({ label, href }) => (
            <li>
              <a
                aria-current={Astro.url.pathname === href}
                class:list={[
                  'mobile-nav-link',
                  {
                    active:
                      Astro.url.pathname === href ||
                      (href !== '/' && Astro.url.pathname.startsWith(href)),
                  },
                ]}
                href={href}
              >
                {label}
              </a>
            </li>
          ))
        }
      </ul>

      <SectionDivider />

      <div class='mobile-menu-footer'>
        <div class='mobile-socials'>
          {
            iconLinks.map(({ href, icon, label }) => (
              <a href={href} class='mobile-social-link' target='_blank' rel='noopener noreferrer'>
                <span class='sr-only'>{label}</span>
                <Icon icon={icon} size='1em' />
              </a>
            ))
          }
        </div>
        <div class='mobile-theme-toggle'>
          <ThemeToggle />
        </div>
      </div>
    </div>
  </div>
</nav>

<script>
  class MenuButton extends HTMLElement {
    private scrollPosition = 0;

    constructor() {
      super();

      this.appendChild(this.querySelector('template')!.content.cloneNode(true));
      const btn = this.querySelector('button')!;
      const menu = document.getElementById('mobile-menu')!;
      const closeBtn = menu.querySelector('.close-menu')! as HTMLButtonElement;
      const body = document.body;
      const html = document.documentElement;

      menu.hidden = true;

      const setExpanded = (expand: boolean) => {
        btn.setAttribute('aria-expanded', expand ? 'true' : 'false');
        menu.hidden = !expand;
        btn.classList.toggle('active', expand);

        if (expand) {
          // Store current scroll position
          this.scrollPosition = window.pageYOffset || html.scrollTop || body.scrollTop || 0;

          // Apply styles to prevent scrolling while preserving position
          body.style.overflow = 'hidden';
          body.style.position = 'fixed';
          body.style.top = `-${this.scrollPosition}px`;
          body.style.width = '100%';
          body.style.left = '0';
          html.style.overflow = 'hidden';

          // Focus management
          closeBtn.focus();
        } else {
          // Restore scrolling and position
          body.style.overflow = '';
          body.style.position = '';
          body.style.top = '';
          body.style.width = '';
          body.style.left = '';
          html.style.overflow = '';

          // Restore scroll position instantly (no smooth scrolling)
          const originalBehavior = document.documentElement.style.scrollBehavior;
          document.documentElement.style.scrollBehavior = 'auto';
          window.scrollTo(0, this.scrollPosition);
          // Restore original scroll behavior after a frame
          requestAnimationFrame(() => {
            document.documentElement.style.scrollBehavior = originalBehavior;
          });

          // Focus management
          btn.focus();
        }
      };

      // Event listeners
      btn.addEventListener('click', () => setExpanded(menu.hidden));
      closeBtn.addEventListener('click', () => setExpanded(false));

      // Close menu when clicking nav links
      const navLinks = menu.querySelectorAll('.mobile-nav-link');
      navLinks.forEach((link) => {
        link.addEventListener('click', () => setExpanded(false));
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !menu.hidden) {
          setExpanded(false);
        }
      });

      // Note: No "click outside to close" needed since this is a full-screen mobile menu

      // Handle viewport changes
      const handleViewports = (e: MediaQueryList | MediaQueryListEvent) => {
        if (e.matches) {
          setExpanded(false);
          btn.hidden = true;
        } else {
          btn.hidden = false;
        }
      };

      const mediaQueries = window.matchMedia('(min-width: 768px)');
      handleViewports(mediaQueries);
      mediaQueries.addEventListener('change', handleViewports);

      // Trap focus within mobile menu when open
      const trapFocus = (e: KeyboardEvent) => {
        if (menu.hidden) return;

        const focusableElements = menu.querySelectorAll(
          'button, a[href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0] as HTMLElement;
        const lastElement = focusableElements[focusableElements.length - 1] as HTMLElement;

        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      };

      document.addEventListener('keydown', trapFocus);
    }
  }

  customElements.define('menu-button', MenuButton);
</script>

<style>
  .navbar {
    @apply fixed top-0 left-0 right-0 z-[9999] font-medium;
    backdrop-filter: blur(32px);
    -webkit-backdrop-filter: blur(32px);
    transition: all 0.3s ease-out;
  }

  .nav-link {
    @apply px-4 py-2 text-sm font-medium no-underline rounded-full;
    @apply transition-all duration-200 ease-in-out;
    color: var(--gray-300);
    position: relative;
  }

  .nav-link:hover {
    color: var(--gray-0);
    background: var(--gray-800);
    transform: translateY(-1px);
  }

  .nav-link.active {
    color: var(--accent-text-over);
    background: var(--accent-regular);
    box-shadow: 0 4px 12px rgba(var(--accent-regular-rgb), 0.3);
  }

  .social-link {
    @apply p-1 rounded-full no-underline transition-all duration-200;
    color: var(--gray-300);
    background: var(--gray-800);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
  }

  .social-link:hover {
    color: var(--accent-regular);
    background: var(--gray-700);
    transform: translateY(-2px);
  }

  .brand-title {
    @apply flex items-center gap-2 text-xl font-bold no-underline;
    color: var(--gray-0);
    transition: color 0.3s ease;
  }

  .brand-title:hover {
    color: var(--accent-regular);
  }

  /* Mobile Menu Button */
  .menu-toggle {
    @apply md:hidden relative border-0 cursor-pointer;
    @apply transition-all duration-200;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border-radius: 0.5rem;
  }

  .menu-toggle:hover {
    background: rgba(var(--gray-800-rgb), 0.5);
  }

  .menu-toggle:focus-visible {
    outline: 2px solid var(--accent-regular);
    outline-offset: 2px;
  }

  .hamburger {
    width: 1.5rem;
    height: 1.25rem;
  }

  .hamburger span {
    @apply block absolute h-0.5 w-full left-0 rounded-sm transition-all duration-300;
    background-color: var(--gray-0);
    origin: center;
  }

  .hamburger span:nth-child(1) {
    top: 0;
  }

  .hamburger span:nth-child(2) {
    top: 50%;
    transform: translateY(-50%);
  }

  .hamburger span:nth-child(3) {
    bottom: 0;
  }

  .menu-toggle:hover .hamburger span {
    background-color: var(--accent-regular);
  }

  .menu-toggle.active .hamburger span:nth-child(1) {
    transform: rotate(45deg) translate(0.375rem, 0.125rem);
  }

  .menu-toggle.active .hamburger span:nth-child(2) {
    opacity: 0;
  }

  .menu-toggle.active .hamburger span:nth-child(3) {
    transform: rotate(-45deg) translate(0.375rem, -0.125rem);
  }

  .mobile-menu {
    @apply fixed inset-0 z-[9998] md:hidden;
    animation: fadeIn 0.3s ease-out;
    height: 100vh;
    height: 100dvh;
    width: 100vw;
    width: 100dvw;
    background: var(--gray-999);
  }

  .mobile-menu[hidden] {
    display: none;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .mobile-menu-header {
    @apply flex items-center justify-between h-16;
    flex-shrink: 0;
    padding: 0 1.5rem;
    background: transparent;
    border-bottom: 1px solid var(--gray-800);
    backdrop-filter: blur(32px);
    -webkit-backdrop-filter: blur(32px);
  }

  .close-menu {
    @apply border-0 cursor-pointer transition-all duration-200;
    background: transparent;
    color: var(--gray-0);
    padding: 0.5rem;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
  }

  .close-menu:hover {
    color: var(--accent-regular);
    background: rgba(var(--gray-800-rgb), 0.5);
  }

  .close-menu:focus-visible {
    outline: 2px solid var(--accent-regular);
    outline-offset: 2px;
  }

  .mobile-menu-content {
    @apply flex flex-col px-4;
    height: calc(100vh - 4rem);
    height: calc(100dvh - 4rem);
    overflow-y: auto;
    overscroll-behavior: contain;
  }

  .mobile-nav-items {
    @apply flex-1 list-none m-0 p-0 space-y-3;
    padding-top: 2rem;
    padding-bottom: 2rem;
  }

  .mobile-nav-link {
    @apply block px-6 py-4 text-lg font-medium no-underline rounded-xl;
    @apply transition-all duration-300 ease-out;
    color: var(--gray-300);
    background: var(--gray-900);
    border: 1px solid var(--gray-800);
  }

  .mobile-nav-link:hover {
    color: var(--gray-0);
    background: var(--gray-800);
    transform: translateX(8px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .mobile-nav-link:focus-visible {
    outline: 2px solid var(--accent-regular);
    outline-offset: 2px;
  }

  .mobile-nav-link.active {
    color: var(--accent-text-over);
    background: var(--accent-regular);
    box-shadow: 0 4px 20px rgba(var(--accent-regular-rgb), 0.3);
    transform: translateX(4px);
  }

  .mobile-menu-footer {
    @apply pt-6 flex flex-col items-center justify-center;
    flex-shrink: 0;
    margin-top: auto;
    padding-bottom: 2rem;
  }

  .mobile-socials {
    @apply flex justify-center gap-4 mb-6;
  }

  .mobile-social-link {
    @apply p-3 rounded-full no-underline transition-all duration-200;
    color: var(--gray-300);
    background: var(--gray-800);
  }

  .mobile-social-link:hover {
    color: var(--accent-regular);
    background: var(--gray-700);
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 4px 15px rgba(var(--accent-regular-rgb), 0.2);
  }

  .mobile-social-link:focus-visible {
    outline: 2px solid var(--accent-regular);
    outline-offset: 2px;
  }

  .mobile-theme-toggle {
    @apply flex justify-center;
  }

  .sr-only {
    @apply absolute w-px h-px p-0 -m-px overflow-hidden whitespace-nowrap border-0;
    clip: rect(0, 0, 0, 0);
  }

  :global(body) {
    padding-top: 4rem;
  }

  /* Enhanced backdrop filter support */
  @supports (backdrop-filter: blur(20px)) {
    .navbar {
      /* No background color - pure backdrop blur */
    }
  }

  @supports not (backdrop-filter: blur(20px)) {
    .navbar {
      background: rgba(0, 0, 0, 0.85);
    }
  }

  @media (forced-colors: active) {
    .nav-link.active {
      color: SelectedItem;
    }
  }

  /* Enhanced mobile responsiveness */
  @media (max-width: 767px) {
    .mobile-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
  }

  /* Smooth scrolling for better UX */
  @media (prefers-reduced-motion: no-preference) {
    html {
      scroll-behavior: smooth;
    }
  }
</style>
